<!DOCTYPE html>
<html>
<head>
	<script src="javascripts/d3.min.js"></script>
	<script src="javascripts/jquery.min.js"></script>
	<script src="javascripts/underscore-min.js"></script>
	<script src="javascripts/scrollspy.js"></script>
	<style>
		body {font: 20px arial; color:white;}
		
	</style>
</head>
<body style="padding:0px; margin:0px;">


<script>
	
	$(function() {
		var width = 200,
	    	height = 200,
	    	radius = Math.min(width, height) / 2.5,
	    	innerRadius = 0;

		var pie = d3.layout.pie()
		    .sort(null)
		    .value(function(d) { return d.width; });

		

		/*
		var tip = d3.tip()
		  .attr('class', 'd3-tip')
		  .offset([0, 0])
		  .html(function(d) {
		    return d.data.label + ": <span style='color:orangered'>" + d.data.score + "</span>";
		  });
		*/
		var arc = d3.svg.arc()
		  .innerRadius(innerRadius)
		  .outerRadius(function (d) { 
		    return (radius - innerRadius) * (d.data.score) + innerRadius; 
		  });

		var innerArc = d3.svg.arc()
		  .innerRadius(innerRadius)
		  .outerRadius(function (d) { 
		    return ((radius - innerRadius) * (d.data.score) + innerRadius) * Math.random() * 0.7; 
		  });

		var middleArc = d3.svg.arc()
		  .innerRadius(innerRadius)
		  .outerRadius(function (d) { 
		    return ((radius - innerRadius) * (d.data.score) + innerRadius) * Math.random(); 
		  });

		var outlineArc = d3.svg.arc()
		        .innerRadius(innerRadius)
		        .outerRadius(radius);

		var svg = d3.select("body").append("svg")
		    .attr("width", width)
		    .attr("height", height)
		    .append("g")
		    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

		//svg.call(tip);

		//d3.csv('aster_data.csv', function(error, data) {
		
		d3.csv('data/prototype/shanghai.csv', function(error, rawData) {
			radius = Math.min(width, height) / (1.7 + Math.random());
			var fields = [
				{
					'idx': 'airquality_raw',
					'name': 'Air quality',
					'scale': d3.scale.linear
				},
				{
					'idx': 'dust',
					'name': 'Dust',
					'scale': d3.scale.linear
				},
				{
					'idx': 'humidity',
					'name': 'Humidity',
					'scale': d3.scale.linear
				},
				{
					'idx': 'light',
					'name': 'Light',
					'scale': d3.scale.linear
				},
				{
					'idx': 'sound',
					'name': 'Sound',
					'scale': d3.scale.linear
				},
				{
					'idx': 'temperature',
					'name': 'Temperature',
					'scale': d3.scale.linear
				}
			];
			var transformedData = [];
			var scalesGlobal = {}; // Use maxes and mins to calculate d3 scales foreach field

			for (var i = 0; i  < fields.length; i++) {
				var field = fields[i].idx;
				var values = _.pluck(rawData, field);

				scalesGlobal[field] = fields[i].scale()
					.range([0,1])
					.domain([0, _.max(values)]);
			}

			//console.log('temp 11', scalesGlobal['temperature'](11))
			//console.log('airquality_raw 22', scalesGlobal['airquality_raw'](22.0))

			rawData.forEach(function(d) {
				var elems = [];
				for (var i = 0; i  < fields.length; i++) {
					
					elems.push(
						{
							'id': fields[i].idx,
							'order': i,
							'color': '#ddd',
							'weight': 1,
							'score': scalesGlobal[fields[i].idx](d[fields[i].idx]),
							'width': 1,
							'label': fields[i].name
						}
					)
				}
				transformedData.push(elems);
			});
			data = transformedData[0];
			
		  // for (var i = 0; i < data.score; i++) { console.log(data[i].id) }
		  
		  var path = svg.selectAll(".solidArc")
		      .data(pie(data))
		    .enter().append("path")
		      .attr("fill", "#99ccff")
		      .attr("class", "solidArc")
		      .attr("stroke", "#fff")
		      .attr("d", arc)

		   var tpath = svg.selectAll(".middleSolidArc")
		      .data(pie(data))
		    .enter().append("path")
		      .attr("fill", function(d) { return '#ff6633'; })
		      .attr("class", "middleSolidArc")
		      .attr("stroke", "none")
		      .attr("d", middleArc)
		   
		   /*
		   setInterval(function() {
		   		 tpath.transition().duration(1000).attr("d", middleArc)
		   }, 1000);
		   */

		   var path = svg.selectAll(".innerSolidArc")
		      .data(pie(data))
		    .enter().append("path")
		      .attr("fill", function(d) { return '#666'; })
		      .attr("class", "innerSolidArc")
		      .attr("stroke", "none")
		      .attr("d", innerArc)
		      //.on('mouseover', tip.show)
		      //.on('mouseout', tip.hide);
		    var path = svg.selectAll(".solidArcOuter")
		      .data(pie(data))
		    .enter().append("path")
		      .attr("fill", "none")
		      .attr("class", "solidArcOuter")
		      .attr("stroke", "#fff")
		      .attr("d", arc)
		});
	});
	
	

</script>